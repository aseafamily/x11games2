{% extends "base.html" %}

{% block title %}ğŸ­ Charades Challenge - X11 Games{% endblock %}

{% block head %}
<style>
/* NO rotation for setup pages - only normal view */

/* Game screen rotation - ONLY when game is active */
@media screen and (orientation: portrait) and (max-width: 768px) {
  #game-screen.active {
    transform: rotate(90deg);
    transform-origin: center center;
    width: 100vh !important;
    height: 100vw !important;
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    margin-top: -50vw !important;
    margin-left: -50vh !important;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex !important;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  #game-screen.active .game-play-area {
    width: 100%;
    height: 100%;
    max-width: none;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    border: none;
    border-radius: 0;
    background: transparent;
  }
  
  #game-screen.active .timer-section {
    position: static;
    margin: 0;
    text-align: center;
  }
  
  #game-screen.active .timer-display {
    font-size: clamp(2rem, 6vw, 3rem);
    color: #ffa500;
    text-shadow: 0 0 20px rgba(255, 165, 0, 0.8);
  }
  
  #game-screen.active .word-section {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #game-screen.active .current-word {
    font-size: clamp(4rem, 15vw, 8rem);
    line-height: 1;
    text-align: center;
    color: #ffffff;
    text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  #game-screen.active .score-section {
    position: static;
    margin: 0;
    text-align: center;
  }
  
  #game-screen.active .score-value {
    font-size: clamp(1.5rem, 4vw, 2rem);
    color: #00ffff;
    text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
  }
}
</style>
{% endblock %}

{% block content %}
<div class="charades-container">
  <header class="charades-header">
    <h1>ğŸ­ CHARADES CHALLENGE</h1>
    <p style="color: #ffa500; font-size: clamp(1rem, 2.5vw, 1.2rem); text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);">
      ğŸª How many words can you guess? Race against time!
    </p>
    <div style="margin-top: 1rem;">
      <a href="/" style="color: #00ffff; text-decoration: none; font-size: 0.9rem; opacity: 0.8;">â† Back to Game Hub</a>
    </div>
  </header>

  <!-- Category Selection Screen -->
  <div id="category-screen" class="game-screen active">
    <div class="game-area">
      <h2>ğŸ¯ Choose Your Category</h2>
      <div class="category-grid">
        <button class="category-button" data-category="sports">
          âš½ Sports
          <div class="category-desc">Athletes, teams, sports terms</div>
        </button>
        <button class="category-button" data-category="countries">
          ğŸŒ Countries
          <div class="category-desc">Nations and world places</div>
        </button>
        <button class="category-button" data-category="animals">
          ğŸ¦ Animals
          <div class="category-desc">Wild and domestic creatures</div>
        </button>
        <button class="category-button" data-category="movies">
          ğŸ¬ Movies
          <div class="category-desc">Popular films and cinema</div>
        </button>
        <button class="category-button" data-category="food">
          ğŸ• Food
          <div class="category-desc">Dishes and cuisines</div>
        </button>
        <button class="category-button" data-category="professions">
          ğŸ‘” Jobs
          <div class="category-desc">Careers and professions</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Game Setup Screen -->
  <div id="setup-screen" class="game-screen">
    <div class="game-area">
      <h2>ğŸ® Game Setup</h2>
      <div class="setup-content">
        <div class="setup-section">
          <h3>ğŸ­ How to Play Charades:</h3>
          <ol class="instructions">
            <li>One player holds the device facing the team (everyone can see the word)</li>  
            <li>That player acts out the word WITHOUT speaking - use gestures, movements, and expressions!</li>
            <li>Team tries to guess the word as quickly as possible</li>
            <li>Tilt device DOWN significantly when word is guessed correctly</li>
            <li>Tilt device UP significantly to skip if too difficult</li>
            <li>Goal: Guess as many words as possible within the time limit!</li>
          </ol>
        </div>
        
        <div class="setup-section">
          <label for="round-time">â±ï¸ Round Time:</label>
          <select id="round-time" class="time-selector">
            <option value="60">1 minute</option>
            <option value="90">90 seconds</option>
            <option value="120">2 minutes</option>
            <option value="180" selected>3 minutes</option>
            <option value="240">4 minutes</option>
            <option value="300">5 minutes</option>
          </select>
        </div>

        <div id="orientation-permission" class="setup-section" style="display: none;">
          <h3>ğŸ“± Device Motion Required</h3>
          <p>For tilt controls to work, we need permission to access device motion.</p>
          <button id="request-orientation-btn" class="orientation-button">Enable Tilt Controls</button>
        </div>

        <button id="start-game-btn" class="start-button">ğŸš€ Start Game</button>
      </div>
    </div>
  </div>

  <!-- Countdown Screen -->
  <div id="countdown-screen" class="game-screen">
    <div class="game-area">
      <div class="countdown-display">
        <h2>Get Ready!</h2>
        <div id="countdown-number" class="countdown-number">3</div>
        <div class="countdown-text">Ready to act fast? How many can you guess?</div>
      </div>
    </div>
  </div>

  <!-- Game Play Screen -->
  <div id="game-screen" class="game-screen">
    <div class="game-play-area">
      <!-- Timer at top -->
      <div class="timer-section">
        <div id="timer-display" class="timer-display">03:00</div>
      </div>

      <!-- Word Display - Main focus -->
      <div class="word-section">
        <div id="current-word" class="current-word">EXAMPLE</div>
      </div>

      <!-- Simple score at bottom -->
      <div class="score-section">
        <div id="score-value" class="score-value">0</div>
        <div style="font-size: 0.8em; opacity: 0.8;">words guessed</div>
      </div>

      <!-- Hidden controls for fallback -->
      <div class="controls-section" style="display: none;">
        <button id="correct-btn" class="control-button correct-button">âœ… Correct!</button>
        <button id="skip-btn" class="control-button skip-button">â­ï¸ Skip</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="results-screen" class="game-screen">
    <div class="game-area">
      <h2>ğŸ† Game Over!</h2>
      <div class="results-content">
        <div class="final-score">
          <div class="score-circle">
            <span id="final-score" class="final-score-number">0</span>
            <span class="score-label">Words Guessed</span>
          </div>
          <div id="performance-message" class="performance-message"></div>
        </div>
        
        <div class="results-stats">
          <div class="stat-row">
            <span>Correct Guesses:</span>
            <span id="correct-count">0</span>
          </div>
          <div class="stat-row">
            <span>Skipped:</span>
            <span id="skipped-count">0</span>
          </div>
          <div class="stat-row">
            <span>Words per Minute:</span>
            <span id="words-per-minute">0</span>
          </div>
          <div class="stat-row">
            <span>Success Rate:</span>
            <span id="success-rate">0%</span>
          </div>
        </div>

        <div class="word-review">
          <h3>ğŸ“ Words Played:</h3>
          <div id="words-list" class="words-list"></div>
        </div>

        <div class="results-actions">
          <button id="play-again-btn" class="play-again-button">ğŸ”„ Play Again</button>
          <button id="change-category-btn" class="change-category-button">ğŸ¯ Change Category</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Game data
const categories = {
  sports: [
    'Football', 'Basketball', 'Soccer', 'Tennis', 'Baseball', 'Hockey', 'Golf', 'Swimming',
    'Running', 'Boxing', 'Wrestling', 'Cricket', 'Rugby', 'Volleyball', 'Badminton',
    'Table Tennis', 'Skiing', 'Snowboarding', 'Surfing', 'Cycling', 'Marathon', 'Olympics',
    'Stadium', 'Coach', 'Referee', 'Championship', 'Tournament', 'League', 'Team', 'Player',
    'Athlete', 'Medal', 'Trophy', 'Score', 'Goal', 'Touchdown', 'Home Run', 'Slam Dunk'
  ],
  countries: [
    'United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'United Kingdom', 'France',
    'Germany', 'Italy', 'Spain', 'Russia', 'China', 'Japan', 'India', 'Australia',
    'Egypt', 'South Africa', 'Nigeria', 'Kenya', 'Morocco', 'Turkey', 'Greece',
    'Sweden', 'Norway', 'Denmark', 'Netherlands', 'Belgium', 'Switzerland', 'Austria',
    'Poland', 'Portugal', 'Ireland', 'Iceland', 'Finland', 'New Zealand', 'Thailand',
    'Vietnam', 'South Korea', 'Philippines', 'Indonesia', 'Singapore', 'Malaysia'
  ],
  animals: [
    'Lion', 'Tiger', 'Elephant', 'Giraffe', 'Zebra', 'Monkey', 'Gorilla', 'Chimpanzee',
    'Bear', 'Wolf', 'Fox', 'Deer', 'Rabbit', 'Squirrel', 'Cat', 'Dog', 'Horse',
    'Cow', 'Pig', 'Sheep', 'Goat', 'Chicken', 'Duck', 'Eagle', 'Owl', 'Parrot',
    'Penguin', 'Dolphin', 'Whale', 'Shark', 'Fish', 'Octopus', 'Crab', 'Butterfly',
    'Bee', 'Spider', 'Ant', 'Snake', 'Lizard', 'Turtle', 'Frog', 'Kangaroo', 'Koala'
  ],
  movies: [
    'Titanic', 'Avatar', 'Star Wars', 'Jurassic Park', 'The Matrix', 'Superman', 'Batman',
    'Spider-Man', 'Iron Man', 'Avengers', 'Frozen', 'Finding Nemo', 'Toy Story',
    'Shrek', 'The Lion King', 'Beauty and the Beast', 'Aladdin', 'Cinderella',
    'Snow White', 'Pinocchio', 'Bambi', 'Dumbo', 'Cars', 'Monsters Inc', 'Up',
    'Wall-E', 'Ratatouille', 'The Incredibles', 'Inside Out', 'Moana', 'Coco',
    'Harry Potter', 'Lord of the Rings', 'Indiana Jones', 'James Bond', 'Mission Impossible'
  ],
  food: [
    'Pizza', 'Burger', 'Hot Dog', 'Sandwich', 'Pasta', 'Spaghetti', 'Lasagna', 'Tacos',
    'Burrito', 'Sushi', 'Ramen', 'Fried Rice', 'Steak', 'Chicken', 'Fish', 'Salmon',
    'Lobster', 'Shrimp', 'Ice Cream', 'Cake', 'Cookies', 'Chocolate', 'Candy',
    'Popcorn', 'French Fries', 'Onion Rings', 'Nachos', 'Salad', 'Soup', 'Bread',
    'Pancakes', 'Waffles', 'Toast', 'Cereal', 'Oatmeal', 'Yogurt', 'Cheese',
    'Apple Pie', 'Donuts', 'Muffins', 'Bagels', 'Croissant', 'Pretzel'
  ],
  professions: [
    'Doctor', 'Nurse', 'Teacher', 'Police Officer', 'Firefighter', 'Lawyer', 'Engineer',
    'Architect', 'Chef', 'Waiter', 'Pilot', 'Flight Attendant', 'Mechanic', 'Electrician',
    'Plumber', 'Carpenter', 'Painter', 'Artist', 'Musician', 'Actor', 'Writer',
    'Journalist', 'Photographer', 'Dentist', 'Veterinarian', 'Pharmacist', 'Scientist',
    'Researcher', 'Accountant', 'Banker', 'Real Estate Agent', 'Sales Person',
    'Manager', 'Secretary', 'Librarian', 'Farmer', 'Fisherman', 'Barber', 'Hairdresser',
    'Mail Carrier', 'Bus Driver', 'Taxi Driver', 'Security Guard', 'Janitor'
  ]
};

// Game state
let currentCategory = '';
let currentWords = [];
let currentWordIndex = 0;
let score = 0;
let correctCount = 0;
let skippedCount = 0;
let gameTime = 60;
let timeLeft = 60;
let gameTimer = null;
let playedWords = [];
let gameActive = false;

// Device orientation support
let deviceOrientationSupported = false;
let lastBeta = 0;
let orientationThreshold = 75; // degrees - requires more deliberate tilt
let orientationCooldown = false;

// DOM elements
const screens = {
  category: document.getElementById('category-screen'),
  setup: document.getElementById('setup-screen'),
  countdown: document.getElementById('countdown-screen'),  
  game: document.getElementById('game-screen'),
  results: document.getElementById('results-screen')
};

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
  setupEventListeners();
  requestDeviceOrientation();
});

function setupEventListeners() {
  // Category selection
  document.querySelectorAll('.category-button').forEach(btn => {
    btn.addEventListener('click', selectCategory);
  });

  // Game setup
  document.getElementById('start-game-btn').addEventListener('click', startCountdown);
  document.getElementById('request-orientation-btn').addEventListener('click', requestDeviceOrientation);
  
  // Game controls
  document.getElementById('correct-btn').addEventListener('click', () => handleAnswer(true));
  document.getElementById('skip-btn').addEventListener('click', () => handleAnswer(false));
  document.getElementById('pause-btn').addEventListener('click', pauseGame);

  // Results screen
  document.getElementById('play-again-btn').addEventListener('click', playAgain);
  document.getElementById('change-category-btn').addEventListener('click', changeCategory);
}

async function requestDeviceOrientation() {
  // For iOS 13+ devices, we need to request permission
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    // Show the permission request button
    document.getElementById('orientation-permission').style.display = 'block';
    
    try {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission === 'granted') {
        deviceOrientationSupported = true;
        window.addEventListener('deviceorientation', handleDeviceOrientation, true);
        console.log('Device orientation permission granted');
        document.getElementById('orientation-permission').style.display = 'none';
      } else {
        console.log('Device orientation permission denied - showing controls');
        showFallbackControls();
      }
    } catch (error) {
      console.log('Error requesting device orientation permission:', error);
      showFallbackControls();
    }
  } else if (window.DeviceOrientationEvent) {
    // For other devices
    deviceOrientationSupported = true;
    window.addEventListener('deviceorientation', handleDeviceOrientation, true);
    console.log('Device orientation supported');
  } else {
    console.log('Device orientation not supported - showing controls');
    showFallbackControls();
  }
}

function showFallbackControls() {
  // Show the control buttons if tilt doesn't work
  setTimeout(() => {
    const controls = document.querySelector('.controls-section');
    if (controls && gameActive) {
      controls.style.display = 'flex';
    }
  }, 3000); // Show after 3 seconds if no tilt detected
}

function selectCategory(event) {
  const category = event.currentTarget.dataset.category;
  currentCategory = category;
  currentWords = [...categories[category]];
  shuffleArray(currentWords);
  showScreen('setup');
  
  // Check if we need to show orientation permission for iOS
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function' && !deviceOrientationSupported) {
    document.getElementById('orientation-permission').style.display = 'block';
  }
}

function handleDeviceOrientation(event) {
  if (!gameActive || orientationCooldown) return;

  const beta = event.beta; // Front-to-back tilt (-180 to 180)
  
  if (beta === null || beta === undefined) return;
  
  console.log('Device orientation beta:', beta);
  
  // Tilt forward/down (beta > threshold) = Correct
  if (beta > orientationThreshold && lastBeta <= orientationThreshold) {
    console.log('Tilt DOWN detected - Correct!');
    handleAnswer(true);
    triggerOrientationCooldown();
  }
  // Tilt backward/up (beta < -threshold) = Skip
  else if (beta < -orientationThreshold && lastBeta >= -orientationThreshold) {
    console.log('Tilt UP detected - Skip!');
    handleAnswer(false);
    triggerOrientationCooldown();
  }
  
  lastBeta = beta;
}

function triggerOrientationCooldown() {
  orientationCooldown = true;
  setTimeout(() => {
    orientationCooldown = false;
  }, 1000); // 1 second cooldown
}



function showScreen(screenName) {
  Object.values(screens).forEach(screen => screen.classList.remove('active'));
  screens[screenName].classList.add('active');
}

function startCountdown() {
  gameTime = parseInt(document.getElementById('round-time').value);
  timeLeft = gameTime;
  showScreen('countdown');
  
  let count = 3;
  const countdownElement = document.getElementById('countdown-number');
  
  const countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownElement.textContent = count;
    } else {
      clearInterval(countdownInterval);
      startGame();
    }
  }, 1000);
}

function startGame() {
  showScreen('game');
  gameActive = true;
  score = 0;
  correctCount = 0;
  skippedCount = 0;
  currentWordIndex = 0;
  playedWords = [];
  
  // Enter fullscreen landscape mode
  enterFullscreenLandscape();
  
  updateDisplay();
  startTimer();
}

async function enterFullscreenLandscape() {
  try {
    // First, lock to landscape orientation (this will make iPhone show landscape mode even in portrait)
    if (screen.orientation && screen.orientation.lock) {
      try {
        await screen.orientation.lock('landscape');
        console.log('Screen locked to landscape - iPhone will show landscape mode');
      } catch (e) {
        console.log('Could not lock screen orientation:', e);
      }
    } else if (screen.lockOrientation) {
      screen.lockOrientation('landscape');
    } else if (screen.webkitLockOrientation) {
      screen.webkitLockOrientation('landscape');
    } else if (screen.mozLockOrientation) {
      screen.mozLockOrientation('landscape');
    }
    
    // Then request fullscreen
    const gameScreen = document.getElementById('game-screen');
    if (gameScreen.requestFullscreen) {
      await gameScreen.requestFullscreen();
    } else if (gameScreen.webkitRequestFullscreen) {
      await gameScreen.webkitRequestFullscreen();
    } else if (gameScreen.msRequestFullscreen) {
      await gameScreen.msRequestFullscreen();
    }
    
    // Add fullscreen class for styling
    document.body.classList.add('fullscreen-game');
    
  } catch (error) {
    console.log('Fullscreen/landscape request failed:', error);
    // Continue without fullscreen if it fails
  }
}

function exitFullscreenLandscape() {
  try {
    // Exit fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    
    // Unlock screen orientation
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock();
    } else if (screen.unlockOrientation) {
      screen.unlockOrientation();
    } else if (screen.webkitUnlockOrientation) {
      screen.webkitUnlockOrientation();
    } else if (screen.mozUnlockOrientation) {
      screen.mozUnlockOrientation();
    }
    
    // Remove fullscreen class
    document.body.classList.remove('fullscreen-game');
    
  } catch (error) {
    console.log('Exit fullscreen failed:', error);
  }
}

function updateDisplay() {
  if (currentWordIndex >= currentWords.length) {
    // Reshuffle if we run out of words
    shuffleArray(currentWords);
    currentWordIndex = 0;
  }

  document.getElementById('current-word').textContent = currentWords[currentWordIndex];
  document.getElementById('current-category').textContent = currentCategory.toUpperCase();
  document.getElementById('score-value').textContent = score;
}

function handleAnswer(correct) {
  if (!gameActive) return;

  const word = currentWords[currentWordIndex];
  playedWords.push({ word, correct });

  if (correct) {
    score += 1;
    correctCount += 1;
    showFeedback('âœ… Correct!', 'correct');
  } else {
    skippedCount += 1;
    showFeedback('â­ï¸ Skipped', 'skip');
  }

  currentWordIndex++;
  setTimeout(() => {
    updateDisplay();
  }, 800);
}

function showFeedback(message, type) {
  const feedback = document.createElement('div');
  feedback.className = `feedback-popup ${type}`;
  feedback.textContent = message;
  document.querySelector('.game-play-area').appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 800);
}

function startTimer() {
  const timerDisplay = document.getElementById('timer-display');
  const timerProgress = document.getElementById('timer-progress');
  
  gameTimer = setInterval(() => {
    timeLeft--;
    
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = ((gameTime - timeLeft) / gameTime) * 100;
    timerProgress.style.width = `${progress}%`;
    
    if (timeLeft <= 0) {
      endGame();
    }
  }, 1000);
}

function pauseGame() {
  gameActive = false;
  clearInterval(gameTimer);
  // Could add pause screen here
}

function endGame() {
  gameActive = false;
  clearInterval(gameTimer);
  
  // Exit fullscreen landscape mode
  exitFullscreenLandscape();
  
  showResults();
}

function showResults() {
  showScreen('results');
  
  document.getElementById('final-score').textContent = score;
  document.getElementById('correct-count').textContent = correctCount;
  document.getElementById('skipped-count').textContent = skippedCount;
  
  const totalAttempts = correctCount + skippedCount;
  const successRate = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
  document.getElementById('success-rate').textContent = `${successRate}%`;
  
  // Calculate words per minute based on correct guesses
  const gameTimeMinutes = gameTime / 60;
  const wordsPerMinute = gameTimeMinutes > 0 ? Math.round(correctCount / gameTimeMinutes) : 0;
  document.getElementById('words-per-minute').textContent = wordsPerMinute;
  
  // Add performance message
  let performanceMessage = '';
  if (wordsPerMinute >= 20) {
    performanceMessage = 'ğŸ”¥ INCREDIBLE! You\'re a Charades master!';
  } else if (wordsPerMinute >= 15) {
    performanceMessage = 'â­ EXCELLENT! Amazing teamwork!';
  } else if (wordsPerMinute >= 10) {
    performanceMessage = 'ğŸ‘ GREAT JOB! Well done team!';
  } else if (wordsPerMinute >= 5) {
    performanceMessage = 'ğŸ‘ GOOD START! Keep practicing!';
  } else {
    performanceMessage = 'ğŸ­ Nice try! Charades takes practice!';
  }
  
  // Add performance message to results if element exists
  const perfElement = document.getElementById('performance-message');
  if (perfElement) {
    perfElement.textContent = performanceMessage;
  }
  
  displayWordsReview();
}

function displayWordsReview() {
  const wordsList = document.getElementById('words-list');
  wordsList.innerHTML = '';
  
  playedWords.forEach(({ word, correct }) => {
    const wordItem = document.createElement('div');
    wordItem.className = `word-review-item ${correct ? 'correct' : 'skipped'}`;
    wordItem.innerHTML = `
      <span class="word-text">${word}</span>
      <span class="word-result">${correct ? 'âœ…' : 'â­ï¸'}</span>
    `;
    wordsList.appendChild(wordItem);
  });
}

function playAgain() {
  currentWords = [...categories[currentCategory]];
  shuffleArray(currentWords);
  startCountdown();
}

function changeCategory() {
  showScreen('category');
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
</script>
{% endblock %}